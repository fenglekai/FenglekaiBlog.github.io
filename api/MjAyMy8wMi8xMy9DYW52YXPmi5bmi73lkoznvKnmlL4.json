{"title":"Canvas拖拽和缩放","date":"2023-02-13T08:00:27.000Z","date_formatted":{"ll":"2023年2月13日","L":"2023/02/13","MM-DD":"02-13"},"thumbnail":"https://picsum.photos/1280/720?random=12","color":"#111","link":"2023/02/13/Canvas拖拽和缩放","tags":["🔥前端","🚀框架"],"updated":"2023-02-13T08:13:32.699Z","content":"<h2 id=\"vue实现版本\">Vue实现版本<a title=\"#vue实现版本\" href=\"#vue实现版本\"></a></h2>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;template&gt;</span><br><span class=\"line\">  &lt;div</span><br><span class=\"line\">    ref=&quot;mapWrapper&quot;</span><br><span class=\"line\">    class=&quot;relative overflow-hidden w-full&quot;</span><br><span class=\"line\">    style=&quot;height: 68vh&quot;</span><br><span class=\"line\">  &gt;</span><br><span class=\"line\">    &lt;canvas ref=&quot;mapFactory&quot; style=&quot;cursor: grab&quot;&gt;&lt;/canvas&gt;</span><br><span class=\"line\">    &lt;div class=&quot;absolute bottom-0 right-0&quot;&gt;</span><br><span class=\"line\">      &lt;el-button type=&quot;primary&quot; @click=&quot;resetMap&quot;&gt;reset&lt;/el-button&gt;</span><br><span class=\"line\">    &lt;/div&gt;</span><br><span class=\"line\">  &lt;/div&gt;</span><br><span class=\"line\">&lt;/template&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;script&gt;</span><br><span class=\"line\">export default &#123;</span><br><span class=\"line\">  name: &quot;mapCanvas&quot;,</span><br><span class=\"line\">  data() &#123;</span><br><span class=\"line\">    return &#123;</span><br><span class=\"line\">      WIDTH: 0,</span><br><span class=\"line\">      HEIGHT: 0,</span><br><span class=\"line\">      scale: 1,</span><br><span class=\"line\">      current: &#123;</span><br><span class=\"line\">        x: 0,</span><br><span class=\"line\">        y: 0,</span><br><span class=\"line\">        width: 0,</span><br><span class=\"line\">        height: 0,</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      move: false,</span><br><span class=\"line\">      moveBefore: &#123; x: 0, y: 0 &#125;,</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  mounted() &#123;</span><br><span class=\"line\">    this.initCanvas();</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  methods: &#123;</span><br><span class=\"line\">    limit(min, max) &#123;</span><br><span class=\"line\">      return (val) =&gt; Math.min(Math.max(val, min), max);</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    loadImage() &#123;</span><br><span class=\"line\">      return new Promise((resolve) =&gt; &#123;</span><br><span class=\"line\">        const mapImg = new Image();</span><br><span class=\"line\">        mapImg.src = `$&#123;require(&quot;assets/3F(6.197565,11.6)(129.2361,73.1).png&quot;)&#125;`;</span><br><span class=\"line\">        mapImg.addEventListener(&quot;load&quot;, () =&gt; resolve(mapImg));</span><br><span class=\"line\">        mapImg.addEventListener(&quot;error&quot;, () =&gt; resolve(null));</span><br><span class=\"line\">      &#125;);</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    // canvas缩放</span><br><span class=\"line\">    async zoom(position) &#123;</span><br><span class=\"line\">      const mapFactory = this.$refs.mapFactory;</span><br><span class=\"line\">      const mapContext = mapFactory.getContext(&quot;2d&quot;);</span><br><span class=\"line\">      // 加载图片</span><br><span class=\"line\">      const img = await this.loadImage();</span><br><span class=\"line\">      if (!img) return;</span><br><span class=\"line\">      mapContext.clearRect(0, 0, this.WIDTH, this.HEIGHT);</span><br><span class=\"line\">      const origin = &#123;</span><br><span class=\"line\">        x: position.x - this.current.x,</span><br><span class=\"line\">        y: position.y - this.current.y,</span><br><span class=\"line\">      &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">      const newWidth = this.WIDTH * this.scale;</span><br><span class=\"line\">      const newHeight = this.HEIGHT * this.scale;</span><br><span class=\"line\"></span><br><span class=\"line\">      const dx =</span><br><span class=\"line\">        this.current.x +</span><br><span class=\"line\">        (origin.x - (origin.x / this.current.width) * newWidth);</span><br><span class=\"line\">      const dy =</span><br><span class=\"line\">        this.current.y +</span><br><span class=\"line\">        (origin.y - (origin.y / this.current.height) * newHeight);</span><br><span class=\"line\"></span><br><span class=\"line\">      this.current.x = dx;</span><br><span class=\"line\">      this.current.y = dy;</span><br><span class=\"line\">      this.current.width = newWidth;</span><br><span class=\"line\">      this.current.height = newHeight;</span><br><span class=\"line\">      mapContext.drawImage(img, dx, dy, newWidth, newHeight);</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    // canvas开始移动</span><br><span class=\"line\">    canvasDown(e) &#123;</span><br><span class=\"line\">      const mapFactory = this.$refs.mapFactory;</span><br><span class=\"line\">      mapFactory.style.cursor = &quot;grabbing&quot;;</span><br><span class=\"line\">      this.move = true;</span><br><span class=\"line\">      const mousePos = this.getCanvasMousePos(e);</span><br><span class=\"line\">      this.moveBefore = &#123; ...mousePos &#125;;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    // canvas移动中</span><br><span class=\"line\">    async canvasMove(e) &#123;</span><br><span class=\"line\">      if (this.move) &#123;</span><br><span class=\"line\">        const mousePos = this.getCanvasMousePos(e);</span><br><span class=\"line\">        const mapFactory = this.$refs.mapFactory;</span><br><span class=\"line\">        const mapContext = mapFactory.getContext(&quot;2d&quot;);</span><br><span class=\"line\">        // 加载图片</span><br><span class=\"line\">        const img = await this.loadImage();</span><br><span class=\"line\">        if (!img) return;</span><br><span class=\"line\">        mapContext.clearRect(0, 0, this.WIDTH, this.HEIGHT);</span><br><span class=\"line\">        this.current.x += mousePos.x - this.moveBefore.x;</span><br><span class=\"line\">        this.current.y += mousePos.y - this.moveBefore.y;</span><br><span class=\"line\">        this.moveBefore = &#123; ...mousePos &#125;;</span><br><span class=\"line\">        mapContext.drawImage(</span><br><span class=\"line\">          img,</span><br><span class=\"line\">          this.current.x,</span><br><span class=\"line\">          this.current.y,</span><br><span class=\"line\">          this.current.width,</span><br><span class=\"line\">          this.current.height</span><br><span class=\"line\">        );</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    // canvas结束移动</span><br><span class=\"line\">    canvasUp() &#123;&#125;,</span><br><span class=\"line\">    /**</span><br><span class=\"line\">     * @description: 鼠标坐标转换,将鼠标点的位置，转换为canvas元素内部点击的位置</span><br><span class=\"line\">     * @param &#123;*&#125; e 鼠标事件</span><br><span class=\"line\">     * @return &#123;*&#125;</span><br><span class=\"line\">     */</span><br><span class=\"line\">    getCanvasMousePos(e) &#123;</span><br><span class=\"line\">      const mapFactory = this.$refs.mapFactory;</span><br><span class=\"line\">      let rect = mapFactory.getBoundingClientRect();</span><br><span class=\"line\">      let x = ((e.clientX - rect.left) * mapFactory.width) / rect.width;</span><br><span class=\"line\">      let y = ((e.clientY - rect.top) * mapFactory.height) / rect.height;</span><br><span class=\"line\"></span><br><span class=\"line\">      return &#123;</span><br><span class=\"line\">        x: x,</span><br><span class=\"line\">        y: y,</span><br><span class=\"line\">      &#125;;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    initCanvas() &#123;</span><br><span class=\"line\">      const mapWrapper = this.$refs.mapWrapper;</span><br><span class=\"line\">      const mapFactory = this.$refs.mapFactory;</span><br><span class=\"line\">      this.WIDTH = mapFactory.width = mapWrapper.clientWidth;</span><br><span class=\"line\">      this.HEIGHT = mapFactory.height = mapWrapper.clientHeight;</span><br><span class=\"line\"></span><br><span class=\"line\">      this.current = &#123; x: 0, y: 0, width: this.WIDTH, height: this.HEIGHT &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">      this.zoom(&#123; x: 0, y: 0 &#125;);</span><br><span class=\"line\">      // 中键缩放事件</span><br><span class=\"line\">      mapFactory.addEventListener(&quot;mousewheel&quot;, (e) =&gt; &#123;</span><br><span class=\"line\">        e.preventDefault();</span><br><span class=\"line\">        const direction = this.limit(-1, 1)(e.deltaY || e.detail);</span><br><span class=\"line\">        this.scale -= direction * 0.5;</span><br><span class=\"line\">        if (this.scale &lt; 1) return (this.scale = 1);</span><br><span class=\"line\">        let mousePos = this.getCanvasMousePos(e);</span><br><span class=\"line\">        this.zoom(mousePos);</span><br><span class=\"line\">      &#125;);</span><br><span class=\"line\">      // 鼠标点下事件</span><br><span class=\"line\">      mapFactory.addEventListener(&quot;mousedown&quot;, (e) =&gt; &#123;</span><br><span class=\"line\">        e.preventDefault();</span><br><span class=\"line\">        this.canvasDown(e);</span><br><span class=\"line\">      &#125;);</span><br><span class=\"line\">      // 鼠标移动事件</span><br><span class=\"line\">      mapFactory.addEventListener(&quot;mousemove&quot;, (e) =&gt; &#123;</span><br><span class=\"line\">        e.preventDefault();</span><br><span class=\"line\">        this.canvasMove(e);</span><br><span class=\"line\">      &#125;);</span><br><span class=\"line\">      // 鼠标松开事件</span><br><span class=\"line\">      mapFactory.addEventListener(&quot;mouseup&quot;, (e) =&gt; &#123;</span><br><span class=\"line\">        e.preventDefault();</span><br><span class=\"line\">        mapFactory.style.cursor = &quot;grab&quot;;</span><br><span class=\"line\">        this.move = false;</span><br><span class=\"line\">      &#125;);</span><br><span class=\"line\">      // 鼠标离开事件</span><br><span class=\"line\">      mapFactory.addEventListener(&quot;mouseleave&quot;, (e) =&gt; &#123;</span><br><span class=\"line\">        e.preventDefault();</span><br><span class=\"line\">        mapFactory.style.cursor = &quot;grab&quot;;</span><br><span class=\"line\">        this.move = false;</span><br><span class=\"line\">      &#125;);</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    resetMap() &#123;</span><br><span class=\"line\">      this.scale = 1;</span><br><span class=\"line\">      this.current.x = 0;</span><br><span class=\"line\">      this.current.y = 0;</span><br><span class=\"line\">      this.current.width = this.WIDTH;</span><br><span class=\"line\">      this.current.height = this.HEIGHT;</span><br><span class=\"line\">      this.zoom(&#123; x: 0, y: 0 &#125;);</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\">&lt;/script&gt;</span><br></pre></td></tr></table></figure>\n<h2 id=\"借鉴源码\">借鉴源码<a title=\"#借鉴源码\" href=\"#借鉴源码\"></a></h2>\n<h3 id=\"缩放\">缩放<a title=\"#缩放\" href=\"#缩放\"></a></h3>\n<blockquote>\n<p>codepen：<a href=\"https://codepen.io/xty1992a/pen/gOOjoqK?editors=0010\" target=\"_blank\">https://codepen.io/xty1992a/pen/gOOjoqK?editors=0010</a></p>\n</blockquote>\n<h3 id=\"拖拽\">拖拽<a title=\"#拖拽\" href=\"#拖拽\"></a></h3>\n<blockquote>\n<p><a href=\"https://blog.csdn.net/y396397735/article/details/117692565\" target=\"_blank\">https://blog.csdn.net/y396397735/article/details/117692565</a></p>\n</blockquote>\n","prev":{"title":"Ubuntu命令","link":"2023/02/13/Ubuntu命令"},"next":{"title":"前端文件上传与下载","link":"2022/06/27/前端文件上传与下载"},"plink":"https://fenglekai.github.io/2023/02/13/Canvas拖拽和缩放/","toc":[{"id":"vue实现版本","title":"Vue实现版本","index":"1"},{"id":"借鉴源码","title":"借鉴源码","index":"2","children":[{"id":"缩放","title":"缩放","index":"2.1"},{"id":"拖拽","title":"拖拽","index":"2.2"}]}],"reading_time":"796 字约 5 分钟"}